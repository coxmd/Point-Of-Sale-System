$(document).ready(function () {

function ReloadPage() {
        GetAllPeriods();
        GetAllAccounts();
        $("#report").trigger("change")
    }

    ReloadPage()

function GetAllPeriods() {
    var t = $("#BranchID").val()
        , n = $("#PeriodID");
    n.empty();
    n.append("<option><\/option>");
    GetOrPostAsync("GET", "/Accounts/GetAllFiscalPeriods/", t, "").then(t => {
        if (!$.isEmptyObject(t)) {
            for (let r = 0; r < t.length; r++) {
                var i = `<option value="${t[r].fiscalPeriodID}">Fiscal Period ${t[r].fiscalPeriodNo}: ${formatDate(t[r].openDate)} to ${formatDate(t[r].closeDate)}</option>`;
                n.append(i)
            }
            n.select2()
        }
    }
    ).catch(n => Notify(!1, n))
    }

function GetAllAccounts() {
    var t = $("#BranchID").val()
        , n = $("#AccountID");
    n.empty();
    n.append("<option><\/option>");
    GetOrPostAsync("GET", "/Accounts/GetAllAccounts/", t, "").then(t => {
        var i, r;
        if (!$.isEmptyObject(t)) {
            for (i = 0; i < t.length; i++)
                r = `<option value="${t[i].accountID}">${t[i].accountName}</option>`,
                    n.append(r);
            n.select2()
        }
    }
    ).catch(n => Notify(!1, n))
}
function GetAllSubAccounts() {
    var t = $("#AccountID").val()
        , n = $("#SubAccountID");
    n.empty();
    n.append("<option><\/option>");
    GetOrPostAsync("POST", "/Accounts/GetAllSubAccountsByAccountID/", t, "").then(t => {
        var i, r;
        if (!$.isEmptyObject(t)) {
            for (i = 0; i < t.length; i++)
                r = `<option value="${t[i].subAccountID}">${t[i].subAccountName}</option>`,
                    n.append(r);
            n.select2()
        }
    }
    ).catch(n => Notify(!1, n))
}

function GenerateCustomReport(n, t) {
    let r = $("#report").find(":selected").data("id")
        , u = $("#BranchID").val() || 0
        , i = "";
    isEmpty($("#PeriodID").val()) || (i += `${$("#PeriodID").val()},`);
    isEmpty($("#SubAccountID").val()) || (i += `${$("#SubAccountID").val()},`);
    isEmpty($("#DepartmentID").val()) || (i += `${$("#DepartmentID").val()},`);
    $("#DashboardReportIframe").attr("src", `/Dashboard/RenderCustomReport/?reportID=${r}&branchID=${u}&dateFrom=${n}&dateTo=${t}&otherParams=${i}`)
}

var requirePeriod = !1
    , requireAccount = !1
    , requireDept = !1
    , onlyOneBranch = !1
    , requireSubAccount = !1;

$(document).ready(function () {
    $("#dateFrom").val((new Date).toLocalISOString().slice(0, 10));
    $("#dateTo").val((new Date).toLocalISOString().slice(0, 10));
    $("#report").select2({
        placeholder: "Select Report",
        width: "resolve"
    });
    ReloadPage()
});

$("#report").on("change", () => {
    var n = Number($("#report").val());
    if ($("#customBreadCrumb").empty(),
        !isNaN(n))
        if (n === 0)
            $("#secReports").hide(),
                $("#secAnalytics").show();
        else {
            $("#secAnalytics").hide();
            $("#secReports").show();
            switch (n) {
                case -1:
                    HandleCustomReportParameters();
                    break;
                case 1:
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 2:
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 3:
                    $(".select-period-modal").modal("toggle");
                    break;
                case 4:
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 5:
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    requireSubAccount = !0;
                    break;
                case 6:
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 7:
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 8:
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    requireDept = !0;
                    break;
                case 9:
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 10:
                    $(".select-period-modal").modal("toggle");
                    break;
                case 11:
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 12:
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 13:
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 14:
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 15:
                    $(".select-period-modal").modal("toggle");
                    break;
                case 16:
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 17:
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    requireAccount = !0
            }
        }
}
);

    $("#ReportsForm").submit(function (event) {
        event.preventDefault();

        var dashboardReportData = {
            ReportID: Number($("#report").val()),
            DateFrom: $("#dateFrom").val(),
            DateTo: $("#dateTo").val()
        };
        var requestVerificationToken = $("#ReportsForm input[name=__RequestVerificationToken]").val();

        AjaxServerCallAsync("POST", "/Dashboard/GetAccountsReportPath/", dashboardReportData, requestVerificationToken, function (response) {
            var responseData = response.response.reportUrl;

            if (response.status) {
                $("#DashboardReportIframe").attr("src", responseData);

            } else {
                Notify(false, responseData);
            }
        });
    });


    $(".select-period-modal").on("shown.bs.modal", function () {
        onlyOneBranch && $("#ChoosePeriodForm").submit()
    });

$(".select-branch-modal").on("shown.bs.modal", function () {
    onlyOneBranch && $("#ChoosePeriodForm").submit()
});
$("#ChooseBranchForm").submit(n => {
    n.preventDefault();
    $(".select-branch-modal").modal("toggle");
    let t = requirePeriod;
    requirePeriod && (GetAllPeriods(),
        $(".select-period-modal").modal("toggle"),
        requirePeriod = !1);
    (requireAccount || requireSubAccount) && (GetAllAccounts(),
        t || ($(".select-account-modal").modal("toggle"),
            requireAccount = !1));
    requireDept && (LoadDepartments(),
        t || ($(".select-dept-modal").modal("toggle"),
            requireDept = !1));
    $("#customBreadCrumb").append(`<li><a href="Javascript:ReloadPage()">${$("#BranchID option:selected").text()}</a></li>`)
}
);
$("#ChoosePeriodForm").submit(n => {
    n.preventDefault(),
        $(".select-period-modal").modal("toggle"),
        (requireAccount || requireSubAccount) && ($(".select-account-modal").modal("toggle"),
            requireAccount = !1),
        requireDept && ($(".select-dept-modal").modal("toggle"),
            requireDept = !1),
        $("#customBreadCrumb").append(`<li><a href="Javascript:ReloadPage()">${$("#PeriodID option:selected").text()}</a></li>`)
}
);
$("#ChooseAccountForm").submit(n => {
    n.preventDefault(),
        $(".select-account-modal").modal("toggle"),
        requireSubAccount && (GetAllSubAccounts(),
            $(".select-subaccount-modal").modal("toggle"),
            requireSubAccount = !1),
        $("#customBreadCrumb").append(`<li><a href="Javascript:ReloadPage()">${$("#AccountID option:selected").text()}</a></li>`)
}
);
$("#ChooseSubAccountForm").submit(n => {
    n.preventDefault(),
        $(".select-subaccount-modal").modal("toggle"),
        $("#customBreadCrumb").append(`<li><a href="Javascript:ReloadPage()">${$("#SubAccountID option:selected").text()}</a></li>`)
}
);
$("#ChooseDeptForm").submit(n => {
    n.preventDefault(),
        $(".select-dept-modal").modal("toggle"),
        $("#customBreadCrumb").append(`<li><a href="Javascript:ReloadPage()">${$("#DepartmentID option:selected").text()}</a></li>`)
}
);
$(".btnClose").on("click", function () {
    $("#ReportsForm")[0].reset();
    $("#dateFrom").val((new Date).toLocalISOString().slice(0, 10));
    $("#dateTo").val((new Date).toLocalISOString().slice(0, 10));
    requirePeriod = !1;
    requireAccount = !1;
    requireDept = !1;
    requireSubAccount = !1;
    $("#customBreadCrumb").empty();
    $(".modal").modal("hide");
    $("#report").select2({
        placeholder: "Select Report",
        width: "resolve"
    });
    $("#report").trigger("change")
});
$("#ChooseBranchAnalytics").on("change", function () {
    $("#container").empty();
    GrossMargin()
});

});
