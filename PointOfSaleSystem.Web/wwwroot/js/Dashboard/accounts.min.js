$(document).ready(function () {

function ReloadPage() {
        GetAllPeriods();
        GetAllAccounts();
        $("#report").trigger("change")
    }

    ReloadPage()

function GetAllPeriods() {
    var t = $("#BranchID").val()
        , n = $("#PeriodID");
    n.empty();
    n.append("<option><\/option>");
    GetOrPostAsync("GET", "/Accounts/GetAllFiscalPeriods/", t, "").then(t => {
        if (!$.isEmptyObject(t)) {
            for (let r = 0; r < t.length; r++) {
                var i = `<option value="${t[r].fiscalPeriodID}">Fiscal Period ${t[r].fiscalPeriodNo}: ${formatDate(t[r].openDate)} to ${formatDate(t[r].closeDate)}</option>`;
                n.append(i)
            }
            n.select2()
        }
    }
    ).catch(n => Notify(!1, n))
    }

function GetAllAccounts() {
    var t = $("#BranchID").val()
        , n = $("#AccountID");
    n.empty();
    n.append("<option><\/option>");
    GetOrPostAsync("GET", "/Accounts/GetAllAccounts/", t, "").then(t => {
        var i, r;
        if (!$.isEmptyObject(t)) {
            for (i = 0; i < t.length; i++)
                r = `<option value="${t[i].accountID}">${t[i].accountName}</option>`,
                    n.append(r);
            n.select2()
        }
    }
    ).catch(n => Notify(!1, n))
}
function GetAllSubAccounts() {
    var t = $("#AccountID").val()
        , n = $("#SubAccountID");
    n.empty();
    n.append("<option><\/option>");
    GetOrPostAsync("POST", "/Accounts/GetAllSubAccountsByAccountID/", t, "").then(t => {
        var i, r;
        if (!$.isEmptyObject(t)) {
            for (i = 0; i < t.length; i++)
                r = `<option value="${t[i].subAccountID}">${t[i].subAccountName}</option>`,
                    n.append(r);
            n.select2()
        }
    }
    ).catch(n => Notify(!1, n))
}

/*function ResetAllChooseForms() {
    let n = $('form[id^="Choose"');
    for (let t = 0; t < n.length; t++)
        n[t].reset()
}*/
/*function HandleCustomReportParameters() {
    ResetAllChooseForms();
    let i = $("#report").find(":selected").data("params") || ""
        , n = i.split(",")
        , t = !1;
    for (let i = 0; i < n.length; i++) {
        let r = n[i];
        if (!isEmpty(r))
            switch (Number(r)) {
                case 1:
                    t = !0;
                    break;
                case 41:
                    requirePeriod = !0;
                    break;
                case 42:
                    requireAccount = !0;
                    break;
                case 43:
                    requireDept = !0
            }
    }
    t && $(".select-branch-modal").modal("toggle")
}*/
function GenerateCustomReport(n, t) {
    let r = $("#report").find(":selected").data("id")
        , u = $("#BranchID").val() || 0
        , i = "";
    isEmpty($("#PeriodID").val()) || (i += `${$("#PeriodID").val()},`);
    isEmpty($("#SubAccountID").val()) || (i += `${$("#SubAccountID").val()},`);
    isEmpty($("#DepartmentID").val()) || (i += `${$("#DepartmentID").val()},`);
    $("#DashboardReportIframe").attr("src", `/Dashboard/RenderCustomReport/?reportID=${r}&branchID=${u}&dateFrom=${n}&dateTo=${t}&otherParams=${i}`)
}
/*function GrossMargin() {
    var n = $("#ChooseBranchAnalytics").val();
    GetOrPostAsync("POST", "/Dashboard/GrossProfitMargin/", n, "").then(n => {
        $.isEmptyObject(n) || Highcharts.chart("container", {
            chart: {
                showAxes: !0,
                backgroundColor: "#d8e9e8",
                zoomType: "x"
            },
            title: {
                text: "Gross Profit Margin"
            },
            tooltip: {
                shared: !0,
                crosshairs: !0,
                valueSuffix: " %"
            },
            yAxis: {
                title: {
                    text: "Margin (%)"
                },
                gridLineColor: "#afb7b7",
                min: 0,
                tickInterval: 10
            },
            xAxis: {
                categories: n.categories,
                gridLineColor: "#afb7b7"
            },
            legend: {
                layout: "vertical",
                align: "right",
                verticalAlign: "middle"
            },
            plotOptions: {
                series: {
                    states: {
                        inactive: {
                            opacity: 1
                        }
                    }
                }
            },
            credits: {
                enabled: !1
            },
            series: n.series,
            responsive: {
                rules: [{
                    condition: {
                        maxWidth: 500
                    },
                    chartOptions: {
                        legend: {
                            layout: "horizontal",
                            align: "center",
                            verticalAlign: "bottom"
                        }
                    }
                }]
            }
        })
    }
    ).catch(n => Notify(!1, n))
}*/
var requirePeriod = !1
    , requireAccount = !1
    , requireDept = !1
    , onlyOneBranch = !1
    , requireSubAccount = !1;

$(document).ready(function () {
    $("#dateFrom").val((new Date).toLocalISOString().slice(0, 10));
    $("#dateTo").val((new Date).toLocalISOString().slice(0, 10));
    $("#report").select2({
        placeholder: "Select Report",
        width: "resolve"
    });
    ReloadPage()
});

$("#report").on("change", () => {
    var n = Number($("#report").val());
    if ($("#customBreadCrumb").empty(),
        !isNaN(n))
        if (n === 0)
            $("#secReports").hide(),
                $("#secAnalytics").show();
        else {
            $("#secAnalytics").hide();
            $("#secReports").show();
            switch (n) {
                case -1:
                    HandleCustomReportParameters();
                    break;
                case 1:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 2:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 3:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    break;
                case 4:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 5:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    requireSubAccount = !0;
                    break;
                case 6:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 7:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 8:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    requireDept = !0;
                    break;
                case 9:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 10:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    break;
                case 11:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 12:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 13:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 14:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 15:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    break;
                case 16:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    break;
                case 17:
                    //$(".select-branch-modal").modal("toggle");
                    $(".select-period-modal").modal("toggle");
                    requirePeriod = !0;
                    requireAccount = !0
            }
        }
}
);
/*$("#ReportsForm").submit(function (n) {
    var r, t, i;
    if (n.preventDefault(),
        r = Number($("#report").val()),
        !isNaN(r)) {
        t = $("#dateFrom").val();
        i = $("#dateTo").val();
        switch (r) {
            case -1:
                GenerateCustomReport(t, i);
                break;
            case 1:
                //$("#DashboardReportIframe").attr("src", `/Dashboard/TrialBalanceByBranch/?dateFrom=${t}&dateTo=${i}&branchID=${$("#BranchID").val()}&periodID=${$("#PeriodID").val()}`);
                //$("#DashboardReportIframe").attr("src", `/Dashboard/TrialBalanceByBranch/backspace.png`);
                //$("#DashboardReportIframe").attr("src", `/Dashboard/TrialBalanceByBranch/nwind.xml`);
                //$("#DashboardReportIframe").attr("src", `/Dashboard/TrialBalanceByBranch/Invoice.frx`);
                break;
            case 2:
                $("#DashboardReportIframe").attr("src", `/Dashboard/IncomeStatementByBranch/?dateFrom=${t}&dateTo=${i}&branchID=${$("#BranchID").val()}&periodID=${$("#PeriodID").val()}`);
                break;
            case 3:
                $("#DashboardReportIframe").attr("src", `/Dashboard/BalanceSheetByBranch/?dateFrom=${t}&dateTo=${i}&branchID=${$("#BranchID").val()}&periodID=0`);
                break;
            case 4:
                $("#DashboardReportIframe").attr("src", `/Dashboard/GeneralLedgerByBranch/?dateFrom=${t}&dateTo=${i}&branchID=${$("#BranchID").val()}&periodID=${$("#PeriodID").val()}`);
                break;
            case 5:
                $("#DashboardReportIframe").attr("src", `/Dashboard/LedgerSubAccountHistoryByBranch/?dateFrom=${t}&dateTo=${i}&branchID=${$("#BranchID").val()}&periodID=${$("#PeriodID").val()}&subAccountID=${$("#SubAccountID").val()}`);
                break;
            case 6:
                $("#DashboardReportIframe").attr("src", `/Dashboard/AllExpensesByBranch/?dateFrom=${t}&dateTo=${i}&branchID=${$("#BranchID").val()}&periodID=${$("#PeriodID").val()}`);
                break;
            case 7:
                $("#DashboardReportIframe").attr("src", `/Dashboard/AllExpensesSummaryByBranch/?dateFrom=${t}&dateTo=${i}&branchID=${$("#BranchID").val()}&periodID=${$("#PeriodID").val()}`);
                break;
            case 8:
                $("#DashboardReportIframe").attr("src", `/Dashboard/IncomeStatementByDept/?dateFrom=${t}&dateTo=${i}&branchID=${$("#BranchID").val()}&periodID=${$("#PeriodID").val()}&deptID=${$("#DepartmentID").val()}`);
                break;
            case 9:
                $("#DashboardReportIframe").attr("src", `/Dashboard/TrialBalanceByBranchSummary/?dateFrom=${t}&dateTo=${i}&branchID=${$("#BranchID").val()}&periodID=${$("#PeriodID").val()}`);
                break;
            case 10:
                $("#DashboardReportIframe").attr("src", `/Dashboard/CashFlowStatementByBranch/?dateFrom=${t}&dateTo=${i}&branchID=${$("#BranchID").val()}&periodID=0`);
                break;
            case 11:
                $("#DashboardReportIframe").attr("src", `/Dashboard/IncomeStatementSummaryByBranch/?dateFrom=${t}&dateTo=${i}&branchID=${$("#BranchID").val()}&periodID=${$("#PeriodID").val()}`);
                break;
            case 12:
                $("#DashboardReportIframe").attr("src", `/Dashboard/ComprehensiveBalanceSheetByBranch/?dateFrom=${t}&dateTo=${i}&branchID=${$("#BranchID").val()}&periodID=0`);
                break;
            case 13:
                $("#DashboardReportIframe").attr("src", `/Dashboard/ComprehensiveIncomeStatementSummaryByBranch/?dateFrom=${t}&dateTo=${i}&branchID=${$("#BranchID").val()}&periodID=${$("#PeriodID").val()}`);
                break;
            case 14:
                $("#DashboardReportIframe").attr("src", `/Dashboard/ComprehensiveCashFlowStatementByBranch/?branchID=${$("#BranchID").val()}&periodID=${$("#PeriodID").val()}`);
                break;
            case 15:
                $("#DashboardReportIframe").attr("src", `/Dashboard/BalanceSheetSummaryByBranch/?dateFrom=${t}&dateTo=${i}&branchID=${$("#BranchID").val()}&periodID=0`);
                break;
            case 16:
                $("#DashboardReportIframe").attr("src", `/Dashboard/JournalVouchersByBranch/?dateFrom=${t}&dateTo=${i}&branchID=${$("#BranchID").val()}&periodID=${$("#PeriodID").val()}`);
                break;
            case 17:
                $("#DashboardReportIframe").attr("src", `/Dashboard/LedgerAccountHistoryByBranch/?dateFrom=${t}&dateTo=${i}&branchID=${$("#BranchID").val()}&periodID=${$("#PeriodID").val()}&accountID=${$("#AccountID").val()}`)
        }
    }
});*/


    $("#ReportsForm").submit(function (event) {
        event.preventDefault();

        var dashboardReportData = {
            ReportID: Number($("#report").val()),
            DateFrom: $("#dateFrom").val(),
            DateTo: $("#dateTo").val()
        };
        var requestVerificationToken = $("#ReportsForm input[name=__RequestVerificationToken]").val();

        AjaxServerCallAsync("POST", "/Dashboard/GetAccountsReportPath/", dashboardReportData, requestVerificationToken, function (response) {
            var responseData = response.response.reportUrl;

            if (response.status) {
                $("#DashboardReportIframe").attr("src", responseData);

            } else {
                Notify(false, responseData);
            }
        });
    });


//$(".select-branch-modal").on("shown.bs.modal", function () {
    $(".select-period-modal").on("shown.bs.modal", function () {
    //onlyOneBranch && $("#ChooseBranchForm").submit()
        onlyOneBranch && $("#ChoosePeriodForm").submit()
    });

$(".select-branch-modal").on("shown.bs.modal", function () {
    onlyOneBranch && $("#ChoosePeriodForm").submit()
});
$("#ChooseBranchForm").submit(n => {
    n.preventDefault();
    $(".select-branch-modal").modal("toggle");
    let t = requirePeriod;
    requirePeriod && (GetAllPeriods(),
        $(".select-period-modal").modal("toggle"),
        requirePeriod = !1);
    (requireAccount || requireSubAccount) && (GetAllAccounts(),
        t || ($(".select-account-modal").modal("toggle"),
            requireAccount = !1));
    requireDept && (LoadDepartments(),
        t || ($(".select-dept-modal").modal("toggle"),
            requireDept = !1));
    $("#customBreadCrumb").append(`<li><a href="Javascript:ReloadPage()">${$("#BranchID option:selected").text()}</a></li>`)
}
);
$("#ChoosePeriodForm").submit(n => {
    n.preventDefault(),
        $(".select-period-modal").modal("toggle"),
        (requireAccount || requireSubAccount) && ($(".select-account-modal").modal("toggle"),
            requireAccount = !1),
        requireDept && ($(".select-dept-modal").modal("toggle"),
            requireDept = !1),
        $("#customBreadCrumb").append(`<li><a href="Javascript:ReloadPage()">${$("#PeriodID option:selected").text()}</a></li>`)
}
);
$("#ChooseAccountForm").submit(n => {
    n.preventDefault(),
        $(".select-account-modal").modal("toggle"),
        requireSubAccount && (GetAllSubAccounts(),
            $(".select-subaccount-modal").modal("toggle"),
            requireSubAccount = !1),
        $("#customBreadCrumb").append(`<li><a href="Javascript:ReloadPage()">${$("#AccountID option:selected").text()}</a></li>`)
}
);
$("#ChooseSubAccountForm").submit(n => {
    n.preventDefault(),
        $(".select-subaccount-modal").modal("toggle"),
        $("#customBreadCrumb").append(`<li><a href="Javascript:ReloadPage()">${$("#SubAccountID option:selected").text()}</a></li>`)
}
);
$("#ChooseDeptForm").submit(n => {
    n.preventDefault(),
        $(".select-dept-modal").modal("toggle"),
        $("#customBreadCrumb").append(`<li><a href="Javascript:ReloadPage()">${$("#DepartmentID option:selected").text()}</a></li>`)
}
);
$(".btnClose").on("click", function () {
    $("#ReportsForm")[0].reset();
    $("#dateFrom").val((new Date).toLocalISOString().slice(0, 10));
    $("#dateTo").val((new Date).toLocalISOString().slice(0, 10));
    requirePeriod = !1;
    requireAccount = !1;
    requireDept = !1;
    requireSubAccount = !1;
    $("#customBreadCrumb").empty();
    $(".modal").modal("hide");
    $("#report").select2({
        placeholder: "Select Report",
        width: "resolve"
    });
    $("#report").trigger("change")
});
$("#ChooseBranchAnalytics").on("change", function () {
    $("#container").empty();
    GrossMargin()
});

});
